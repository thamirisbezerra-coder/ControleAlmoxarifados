<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Almoxarifado</title>
    <!-- Carregando o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Importando ícones Ionicons -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <!-- Fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Slate-100 */
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        /* Item Selecionado com visual moderno */
        .selected {
            background-color: #f0f9ff !important; /* Sky-50 */
            border-left: 4px solid #0ea5e9; /* Sky-500 */
        }
        
        /* Botões de Navegação (Abas) */
        .warehouse-tab {
            transition: all 0.2s ease;
        }
        .warehouse-tab.active {
            background-color: #1e293b; /* Slate-800 */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transform: translateY(-1px);
        }

        /* Filtros Ativos */
        .filter-btn {
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .filter-btn.active-all { background-color: #334155; color: white; }
        .filter-btn.active-expired { background-color: #ef4444; color: white; }
        .filter-btn.active-warning { background-color: #f59e0b; color: white; }
        
        .filter-btn:not(.active):hover { background-color: #f1f5f9; border-color: #e2e8f0; }

        /* Botão de Tipo de Retirada */
        .withdraw-type-btn.active {
            background-color: #2563eb; 
            color: white;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3);
            border-color: transparent;
        }
        
        /* Modais com Backdrop Blur */
        .modal-backdrop {
            backdrop-filter: blur(4px);
        }

        /* Assinaturas para Impressão */
        .signature-line {
            padding-top: 3rem;
            border-top: 1px dashed #9ca3af;
            text-align: center;
            margin-top: 4rem;
            color: #374151;
        }

        /* Animação Pulse */
        .pulse-anim {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.7); }
            70% { opacity: .9; transform: scale(1.05); box-shadow: 0 0 0 15px rgba(14, 165, 233, 0); }
        }

        @media print {
            body * { visibility: hidden; }
            #printable-receipt, #printable-receipt * { visibility: visible; }
            #printable-receipt {
                position: absolute;
                left: 0; top: 0; width: 100%;
                padding: 0; margin: 0;
            }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden flex flex-col">

    <!-- Cabeçalho Moderno -->
    <header class="bg-white shadow-sm z-20 no-print border-b border-slate-200">
        <div class="container mx-auto px-6 h-20 flex justify-between items-center">
            <div class="flex items-center">
                <!-- LOGO -->
                <img src="https://i.postimg.cc/76mXWMJh/as-02.png" alt="Logo" class="h-10 w-auto mr-4 object-contain">
                <div>
                    <h1 class="text-xl font-bold text-slate-800 tracking-tight">Controle de Almoxarifado</h1>
                    <p class="text-xs text-slate-500 font-medium">Gestão Inteligente de Estoque</p>
                </div>
            </div>
            
            <!-- Notificações e Perfil (Visual) -->
            <div class="flex items-center space-x-4">
                 <div id="notification-bell-container" class="relative p-2 rounded-full hover:bg-slate-100 cursor-pointer transition-colors text-slate-600">
                    <ion-icon name="notifications-outline" class="text-2xl"></ion-icon>
                    <span id="notification-dot" class="absolute top-2 right-2 h-2.5 w-2.5 hidden">
                        <span class="absolute inline-flex h-full w-full animate-ping rounded-full bg-red-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-red-500 border border-white"></span>
                    </span>
                </div>
            </div>
        </div>
    </header>

    <!-- Barra de Navegação -->
    <div class="bg-white border-b border-slate-200 z-10 no-print py-3">
        <div class="container mx-auto px-6 overflow-x-auto">
            <nav id="warehouse-tabs" class="flex space-x-2 min-w-max">
                <button data-warehouse="doces" class="warehouse-tab active px-5 py-2 text-sm font-semibold rounded-full text-slate-600 hover:text-slate-900 hover:bg-slate-100 border border-transparent">Aromas Doces</button>
                <button data-warehouse="salgados" class="warehouse-tab px-5 py-2 text-sm font-semibold rounded-full text-slate-600 hover:text-slate-900 hover:bg-slate-100 border border-transparent">Aromas Salgados</button>
                <button data-warehouse="materiaPrima" class="warehouse-tab px-5 py-2 text-sm font-semibold rounded-full text-slate-600 hover:text-slate-900 hover:bg-slate-100 border border-transparent">Matéria Prima</button>
                <div class="w-px h-6 bg-slate-300 mx-2 self-center"></div>
                <button data-warehouse="relatorio" class="warehouse-tab px-5 py-2 text-sm font-semibold rounded-full text-slate-600 hover:text-slate-900 hover:bg-slate-100 border border-transparent">Relatório Retiradas</button>
                <button data-warehouse="relatorioDescarte" class="warehouse-tab px-5 py-2 text-sm font-semibold rounded-full text-slate-600 hover:text-slate-900 hover:bg-slate-100 border border-transparent">Relatório Descartes</button>
            </nav>
        </div>
    </div>

    <!-- Conteúdo Principal -->
    <main class="flex-grow container mx-auto px-6 py-6 overflow-hidden no-print">
        
        <!-- Grid Principal -->
        <div id="main-view-container" class="grid grid-cols-12 gap-6 h-full">

            <!-- Coluna Esquerda: Lista e Filtros -->
            <div class="col-span-12 lg:col-span-4 flex flex-col h-full bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <!-- Busca e Ações -->
                <div class="p-5 border-b border-slate-100 bg-white z-10">
                    <div class="relative group mb-3">
                        <input type="text" id="search-bar" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all text-sm font-medium" placeholder="Buscar produto, código ou lote...">
                        <ion-icon name="search-outline" class="absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-blue-500 transition-colors"></ion-icon>
                    </div>

                    <!-- NOVO: Filtros de Validade -->
                    <div class="flex space-x-2 mb-4 overflow-x-auto pb-1" id="filter-container">
                        <button data-filter="all" class="filter-btn active active-all px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap bg-slate-100 text-slate-600">
                            Todos
                        </button>
                        <button data-filter="expired" class="filter-btn px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap bg-white text-slate-500 hover:text-red-600">
                            <span class="w-2 h-2 rounded-full bg-red-500 inline-block mr-1"></span> Vencidos
                        </button>
                        <button data-filter="warning" class="filter-btn px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap bg-white text-slate-500 hover:text-amber-600">
                            <span class="w-2 h-2 rounded-full bg-amber-500 inline-block mr-1"></span> A Vencer
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                         <button id="show-add-product-modal-btn" class="col-span-2 bg-slate-800 text-white px-4 py-2.5 rounded-xl text-sm font-semibold hover:bg-slate-900 transition-all flex items-center justify-center shadow-lg shadow-slate-900/10">
                            <ion-icon name="add-circle-outline" class="mr-2 text-lg"></ion-icon>
                            Cadastrar Produto
                        </button>
                        <button id="show-import-modal-btn" class="bg-white border border-slate-200 text-slate-600 px-3 py-2 rounded-xl text-xs font-bold uppercase tracking-wide hover:bg-slate-50 hover:border-slate-300 transition-all flex items-center justify-center">
                            <ion-icon name="cloud-upload-outline" class="mr-2 text-lg"></ion-icon>
                            Importar
                        </button>
                         <button id="export-data-btn" class="bg-white border border-slate-200 text-slate-600 px-3 py-2 rounded-xl text-xs font-bold uppercase tracking-wide hover:bg-slate-50 hover:border-slate-300 transition-all flex items-center justify-center">
                            <ion-icon name="download-outline" class="mr-2 text-lg"></ion-icon>
                            Backup
                        </button>
                        
                        <!-- BOTÃO LIMPAR TUDO -->
                        <button id="clear-all-btn" class="col-span-2 mt-1 bg-white border border-red-200 text-red-600 px-3 py-2 rounded-xl text-xs font-bold uppercase tracking-wide hover:bg-red-50 hover:border-red-300 transition-all flex items-center justify-center group">
                            <ion-icon name="trash-bin-outline" class="mr-2 text-lg group-hover:scale-110 transition-transform"></ion-icon>
                            Limpar Este Setor
                        </button>
                    </div>
                </div>

                <!-- Lista com Scroll -->
                <div id="item-list" class="flex-grow overflow-y-auto custom-scrollbar bg-white">
                    <!-- Itens via JS -->
                </div>
            </div>

            <!-- Coluna Direita: Detalhes -->
            <div class="col-span-12 lg:col-span-8 h-full relative">
                <!-- Container Principal de Detalhes -->
                <div id="item-details" class="bg-white rounded-2xl shadow-sm border border-slate-200 h-full overflow-hidden flex flex-col">
                    <!-- Conteúdo via JS -->
                    <div id="details-placeholder" class="flex flex-col items-center justify-center h-full text-slate-400">
                        <div class="bg-slate-50 p-8 rounded-full mb-6 border border-slate-100">
                            <ion-icon name="cube-outline" class="text-7xl text-slate-300"></ion-icon>
                        </div>
                        <p class="text-2xl font-bold text-slate-700">Selecione um produto</p>
                        <p class="text-slate-500 mt-2">Clique na lista ao lado para ver validade e estoque.</p>
                    </div>
                </div>
                
                <!-- Botão Ajuda Flutuante -->
                <button id="show-help-btn" class="absolute bottom-8 right-8 bg-blue-600 hover:bg-blue-700 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-xl shadow-blue-600/30 transition-transform hover:scale-110 z-20">
                    <ion-icon name="help-outline" class="text-3xl"></ion-icon>
                </button>
            </div>
        </div>

        <!-- Containers de Relatórios -->
        <div id="report-view-container" class="hidden h-full bg-white rounded-2xl shadow-lg border border-slate-100 p-6 overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800">Relatório de Retiradas</h2>
                <div class="flex space-x-3">
                    <button id="clear-report-btn" class="text-red-600 hover:bg-red-50 px-3 py-1 rounded-lg text-sm font-medium transition-colors flex items-center border border-transparent hover:border-red-100">
                        <ion-icon name="trash-outline" class="mr-1"></ion-icon> Limpar Histórico
                    </button>
                    <button class="text-blue-600 hover:bg-blue-50 px-3 py-1 rounded-lg text-sm font-medium transition-colors border border-transparent hover:border-blue-100" onclick="window.print()">
                        <ion-icon name="print-outline" class="mr-1"></ion-icon> Imprimir
                    </button>
                </div>
            </div>
            <div class="overflow-auto flex-grow rounded-xl border border-slate-200">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50 sticky top-0">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Data</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Solicitante</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Setor</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Produto</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Lote</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Qtd.</th>
                        </tr>
                    </thead>
                    <tbody id="report-table-body" class="bg-white divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>

        <div id="discard-report-view-container" class="hidden h-full bg-white rounded-2xl shadow-lg border border-slate-100 p-6 overflow-hidden flex flex-col">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">Relatório de Descartes</h2>
            <div class="overflow-auto flex-grow rounded-xl border border-slate-200">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50 sticky top-0">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Data</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Produto</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Lote</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Qtd.</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Motivo</th>
                        </tr>
                    </thead>
                    <tbody id="discard-report-table-body" class="bg-white divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- ================= MODAIS ================= -->
    
    <!-- Modal Confirmação Limpeza -->
    <div id="clear-all-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 modal-backdrop"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 relative z-10 transform scale-95 opacity-0 transition-all duration-300" id="clear-all-modal-content">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <ion-icon name="warning-outline" class="text-3xl text-red-600"></ion-icon>
                </div>
                <h2 class="text-xl font-bold text-slate-800 mb-2">Tem certeza?</h2>
                <p class="text-sm text-slate-500 mb-6">
                    Isso apagará <strong>todos os dados</strong> de <span id="clear-target-name" class="font-bold text-slate-700">...</span>. <br>Esta ação não pode ser desfeita.
                </p>
                <div class="flex space-x-3">
                    <button class="close-modal-btn flex-1 px-4 py-2 bg-white border border-slate-200 rounded-lg text-slate-700 font-semibold hover:bg-slate-50 transition-colors">Cancelar</button>
                    <button id="confirm-clear-all-btn" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 shadow-lg shadow-red-600/20 transition-colors">Sim, Limpar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ajuda -->
    <div id="help-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 pointer-events-none">
        <div class="absolute inset-0 bg-slate-900/60 modal-backdrop transition-opacity opacity-0 pointer-events-auto" id="help-modal-bg"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg transform scale-95 opacity-0 transition-all duration-300 pointer-events-auto relative overflow-hidden p-8" id="help-modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800">Ajuda & Atalhos</h2>
                <button class="close-modal-btn text-slate-400 hover:text-slate-700 transition-colors"><ion-icon name="close-outline" class="text-3xl"></ion-icon></button>
            </div>
            <div class="space-y-4 text-slate-600">
                <div class="flex items-start">
                    <ion-icon name="create-outline" class="text-xl text-blue-500 mr-3 mt-1"></ion-icon>
                    <p><strong>Editar:</strong> Use os botões de lápis para corrigir nomes de produtos ou dados de lotes incorretos.</p>
                </div>
                <div class="flex items-start">
                    <ion-icon name="trash-outline" class="text-xl text-red-500 mr-3 mt-1"></ion-icon>
                    <p><strong>Excluir:</strong> A lixeira remove produtos inteiros ou registra descarte de quantidade específica.</p>
                </div>
                <div class="flex items-start">
                    <ion-icon name="cloud-upload-outline" class="text-xl text-green-500 mr-3 mt-1"></ion-icon>
                    <p><strong>Importar:</strong> Carregue seus dados antigos via CSV para preencher a lista rapidamente.</p>
                </div>
                 <div class="flex items-start">
                    <ion-icon name="arrow-forward-outline" class="text-xl text-slate-800 mr-3 mt-1"></ion-icon>
                    <p><strong>Saída:</strong> Registre uso interno (sem comprovante) ou externo (gera comprovante para impressão).</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar/Editar Produto -->
    <div id="product-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 pointer-events-none">
        <div class="absolute inset-0 bg-slate-900/60 modal-backdrop transition-opacity opacity-0 pointer-events-auto" id="product-modal-bg"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform scale-95 opacity-0 transition-all duration-300 pointer-events-auto relative overflow-hidden" id="product-modal-content">
            <div class="p-6 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                <h2 class="text-lg font-bold text-slate-800" id="product-modal-title">Cadastrar Produto</h2>
                <button class="close-modal-btn text-slate-400 hover:text-slate-700 transition-colors"><ion-icon name="close-outline" class="text-2xl"></ion-icon></button>
            </div>
            <form id="product-form" class="p-6 space-y-4">
                <input type="hidden" id="edit-original-code">
                
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Almoxarifado</label>
                    <select id="product-warehouse" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none bg-white text-sm">
                        <option value="doces">Aromas Doces</option>
                        <option value="salgados">Aromas Salgados</option>
                        <option value="materiaPrima">Matéria Prima</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Descrição</label>
                    <input type="text" id="product-desc" required class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="Ex: Aroma de Baunilha">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Código (Ref.)</label>
                        <input type="text" id="product-code" required class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="Ex: 1001">
                    </div>
                    <div>
                         <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Formato</label>
                        <select id="product-format" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white text-sm">
                            <option value="Líquido">Líquido</option>
                            <option value="Pó">Pó</option>
                            <option value="Pasta">Pasta</option>
                            <option value="Unidade">Unidade</option>
                            <option value="Kg">Kg</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Localização</label>
                        <input type="text" id="product-loc" required class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="Ex: Corredor A">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Bloco</label>
                        <input type="text" id="product-block" required class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="Ex: Prateleira 2">
                    </div>
                </div>
                
                <div class="pt-4 flex justify-end">
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700 shadow-lg shadow-blue-600/20 transition-all">Salvar Produto</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Adicionar/Editar Lote -->
    <div id="lot-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 pointer-events-none">
        <div class="absolute inset-0 bg-slate-900/60 modal-backdrop transition-opacity opacity-0 pointer-events-auto" id="lot-modal-bg"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform scale-95 opacity-0 transition-all duration-300 pointer-events-auto relative overflow-hidden" id="lot-modal-content">
            <div class="p-6 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                <h2 class="text-lg font-bold text-slate-800" id="lot-modal-title">Gerenciar Lote</h2>
                <button class="close-modal-btn text-slate-400 hover:text-slate-700 transition-colors"><ion-icon name="close-outline" class="text-2xl"></ion-icon></button>
            </div>
            <form id="lot-form" class="p-6 space-y-4">
                <input type="hidden" id="edit-original-lot-id"> 
                
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Código do Lote</label>
                    <input type="text" id="lot-code" required class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="Ex: L2024-A">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Validade</label>
                    <input type="date" id="lot-validity" required class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Estoque</label>
                        <input type="text" id="lot-stock" required class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="Ex: 500 ml">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Status</label>
                        <select id="lot-status" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white text-sm">
                            <option value="OK">OK</option>
                            <option value="Baixo">Baixo</option>
                            <option value="Crítico">Crítico</option>
                        </select>
                    </div>
                </div>
                
                <div class="pt-4 flex justify-end">
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700 shadow-lg shadow-blue-600/20 transition-all">Salvar Lote</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Retirada -->
    <div id="withdraw-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 pointer-events-none">
        <div class="absolute inset-0 bg-slate-900/60 modal-backdrop transition-opacity opacity-0 pointer-events-auto" id="withdraw-modal-bg"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg transform scale-95 opacity-0 transition-all duration-300 pointer-events-auto relative overflow-hidden" id="withdraw-modal-content">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h2 class="text-lg font-bold text-slate-800">Retirar Estoque</h2>
                <button class="close-modal-btn text-slate-400 hover:text-slate-700"><ion-icon name="close-outline" class="text-2xl"></ion-icon></button>
            </div>
            
            <form id="withdraw-form" class="p-6" data-type="internal">
                <input type="hidden" id="withdraw-item-code">
                <input type="hidden" id="withdraw-lot-id">

                <div class="bg-blue-50 p-4 rounded-xl mb-6 border border-blue-100">
                    <p class="text-xs text-blue-500 uppercase font-bold tracking-wide mb-1">Item Selecionado</p>
                    <h3 class="text-lg font-bold text-blue-900" id="withdraw-item-display">Nome do Item</h3>
                    <div class="flex justify-between mt-2 text-sm text-blue-700">
                        <span>Lote: <strong id="withdraw-lot-display">---</strong></span>
                        <span>Disponível: <strong id="withdraw-stock-display">---</strong></span>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-2">Tipo de Saída</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button type="button" id="btn-type-internal" class="withdraw-type-btn active py-2 rounded-lg text-sm font-semibold border border-slate-200 transition-all">Uso Interno</button>
                        <button type="button" id="btn-type-external" class="withdraw-type-btn py-2 rounded-lg text-sm font-semibold border border-slate-200 transition-all">Outro Setor</button>
                    </div>
                </div>

                <div id="external-fields" class="space-y-3 mb-6 hidden">
                    <input type="text" id="withdraw-requester" class="w-full px-4 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Solicitante">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="withdraw-sector" class="w-full px-4 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Setor">
                        <input type="text" id="withdraw-cost-center" class="w-full px-4 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Centro de Custo">
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Quantidade</label>
                    <div class="relative">
                        <input type="number" step="any" id="withdraw-qty" required class="w-full pl-4 pr-12 py-3 border border-slate-200 rounded-lg text-lg font-bold text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0.00">
                        <span class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 font-medium" id="withdraw-unit-display">un</span>
                    </div>
                </div>

                <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-yellow-500/30 transition-all flex items-center justify-center">
                    <ion-icon name="remove-circle-outline" class="mr-2 text-xl"></ion-icon> Confirmar Saída
                </button>
            </form>
        </div>
    </div>

    <!-- Modal Descarte -->
    <div id="discard-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 pointer-events-none">
        <div class="absolute inset-0 bg-slate-900/60 modal-backdrop transition-opacity opacity-0 pointer-events-auto" id="discard-modal-bg"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform scale-95 opacity-0 transition-all duration-300 pointer-events-auto relative overflow-hidden" id="discard-modal-content">
            <div class="p-6 border-b border-slate-100 bg-red-50 flex justify-between items-center">
                <h2 class="text-lg font-bold text-red-900">Registrar Descarte</h2>
                <button class="close-modal-btn text-red-400 hover:text-red-700"><ion-icon name="close-outline" class="text-2xl"></ion-icon></button>
            </div>
            <form id="discard-form" class="p-6 space-y-4">
                <input type="hidden" id="discard-item-code">
                <input type="hidden" id="discard-lot-id">
                
                <div class="text-center mb-4">
                    <p class="text-sm text-slate-500">Item</p>
                    <p class="font-bold text-slate-800 text-lg" id="discard-item-display">Nome</p>
                </div>

                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Quantidade Perdida</label>
                    <input type="number" step="any" id="discard-qty" required class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-red-500 outline-none text-red-600 font-bold">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Motivo</label>
                    <textarea id="discard-reason" rows="2" required class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-red-500 outline-none text-sm" placeholder="Ex: Vencido, Quebrado..."></textarea>
                </div>

                <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2.5 rounded-lg shadow-lg shadow-red-600/30 transition-all">Confirmar Perda</button>
            </form>
        </div>
    </div>

    <!-- Modal Comprovante -->
    <div id="receipt-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-white/90 backdrop-blur-md" id="receipt-bg"></div>
        <div class="bg-white w-full max-w-2xl shadow-2xl border border-slate-200 rounded-none sm:rounded-lg relative z-10 p-8" id="receipt-content">
            <button class="absolute top-4 right-4 text-slate-400 hover:text-slate-800 no-print" id="close-receipt-btn"><ion-icon name="close-outline" class="text-3xl"></ion-icon></button>
            
            <div id="printable-receipt">
                <div class="border-b-2 border-slate-800 pb-4 mb-6 flex justify-between items-end">
                    <div>
                        <h1 class="text-3xl font-bold text-slate-900 uppercase tracking-wider">Comprovante</h1>
                        <p class="text-sm text-slate-500">Retirada de Material</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-mono text-slate-600" id="receipt-date">00/00/0000</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-8 mb-8 text-sm">
                    <div>
                        <p class="text-xs text-slate-400 uppercase font-bold">Solicitante</p>
                        <p class="font-semibold text-slate-800 text-lg" id="receipt-requester">Nome</p>
                    </div>
                    <div>
                        <p class="text-xs text-slate-400 uppercase font-bold">Destino</p>
                        <p class="font-semibold text-slate-800" id="receipt-sector">Setor</p>
                        <p class="text-slate-500" id="receipt-cost-center">CC: 000</p>
                    </div>
                </div>

                <div class="bg-slate-50 p-6 rounded-lg border border-slate-100 mb-8">
                    <p class="text-xs text-slate-400 uppercase font-bold mb-2">Detalhes do Item</p>
                    <div class="flex justify-between items-center">
                        <p class="text-xl font-bold text-slate-900" id="receipt-product">Nome do Produto</p>
                        <p class="text-xl font-bold text-slate-900" id="receipt-qty">00 un</p>
                    </div>
                    <p class="text-sm text-slate-500 mt-1">Lote: <span id="receipt-lot" class="font-mono text-slate-700">L000</span></p>
                </div>

                <div class="grid grid-cols-2 gap-12 mt-12">
                    <div class="signature-line"><p>Assinatura Solicitante</p></div>
                    <div class="signature-line"><p>Assinatura Almoxarifado</p></div>
                </div>
            </div>

            <div class="mt-8 flex justify-end space-x-3 no-print">
                <button onclick="window.print()" class="bg-slate-800 text-white px-6 py-2 rounded-lg font-semibold hover:bg-slate-900">Imprimir</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Importação -->
    <div id="import-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 modal-backdrop"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6 relative z-10 transform scale-95 opacity-0 transition-all duration-300" id="import-modal-content">
            <h2 class="text-xl font-bold text-slate-800 mb-4">Importar CSV</h2>
            
            <!-- Seletor de Segmento -->
            <div class="mb-4">
                <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Destino da Importação</label>
                <select id="import-segment" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none bg-white text-sm text-slate-700">
                    <option value="doces">Aromas Doces</option>
                    <option value="salgados">Aromas Salgados</option>
                    <option value="materiaPrima">Matéria Prima</option>
                </select>
            </div>

            <!-- Checkbox para Substituir Dados -->
            <div class="mb-4 flex items-center bg-slate-50 p-3 rounded-lg border border-slate-100">
                <input type="checkbox" id="import-clear-mode" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 border-gray-300" checked>
                <label for="import-clear-mode" class="ml-2 text-sm font-medium text-slate-700 cursor-pointer select-none">
                    Substituir dados existentes
                    <span class="block text-xs text-slate-400 font-normal">Se marcado, apaga os itens atuais do setor antes de importar os novos.</span>
                </label>
            </div>

            <p class="text-xs text-slate-500 mb-2">Cole os dados com as colunas: <br><strong>CÓDIGO, DESCRIÇÃO, LOTE, QUANTIDADE, FABRICAÇÃO, VALIDADE, DIAS, STATUS</strong></p>
            <textarea id="csv-input" class="w-full h-32 border border-slate-200 rounded-lg p-3 text-xs font-mono mb-4 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="1001, Aroma Baunilha, L2301, 500 ml, 01/01/2024, 01/01/2026, 365, OK..."></textarea>
            <div class="flex justify-end space-x-3">
                <button class="close-modal-btn px-4 py-2 text-slate-500 hover:text-slate-800">Cancelar</button>
                <button id="confirm-import-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-green-700 shadow-lg shadow-green-600/20 transition-all">Processar Importação</button>
            </div>
        </div>
    </div>

    <!-- Notification Toast Container -->
    <div id="toast-container" class="fixed top-24 right-6 z-50 space-y-2 pointer-events-none"></div>

    <!-- SCRIPTS LÓGICA -->
    <script>
        // ESTADO DA APLICAÇÃO
        const state = {
            currentWarehouse: 'doces',
            selectedCode: null,
            searchTerm: '',
            filterStatus: 'all', // 'all', 'expired', 'warning'
            warehouses: {
                doces: [],
                salgados: [],
                materiaPrima: []
            },
            historyWithdraw: [],
            historyDiscard: [],
            notifications: []
        };

        // DOM ELEMENTS
        const els = {
            list: document.getElementById('item-list'),
            details: document.getElementById('item-details'),
            placeholder: document.getElementById('details-placeholder'),
            search: document.getElementById('search-bar'),
            tabs: document.querySelectorAll('.warehouse-tab'),
            filterBtns: document.querySelectorAll('.filter-btn'),
            toastContainer: document.getElementById('toast-container'),
            reportBody: document.getElementById('report-table-body'),
            discardBody: document.getElementById('discard-report-table-body'),
            
            // Botão Ajuda (Elemento Isolado)
            showHelpBtn: document.getElementById('show-help-btn'),
            
            // Modais
            productModal: document.getElementById('product-modal'),
            lotModal: document.getElementById('lot-modal'),
            withdrawModal: document.getElementById('withdraw-modal'),
            discardModal: document.getElementById('discard-modal'),
            receiptModal: document.getElementById('receipt-modal'),
            importModal: document.getElementById('import-modal'),
            helpModal: document.getElementById('help-modal'),
            clearAllModal: document.getElementById('clear-all-modal'), // Modal Limpar Tudo

            // Form Inputs
            prodForm: document.getElementById('product-form'),
            lotForm: document.getElementById('lot-form'),
            withdrawForm: document.getElementById('withdraw-form'),
            discardForm: document.getElementById('discard-form')
        };

        // HELPERS
        const parseStock = (str) => {
            if(!str) return { val: 0, unit: 'un' };
            const m = String(str).match(/^([\d\.,]+)\s*([a-zA-Z]+)?$/);
            if(m) return { val: parseFloat(m[1].replace(',','.')), unit: m[2] || 'un' };
            return { val: parseFloat(str) || 0, unit: 'un' };
        };
        const formatStock = (s) => `${Number(s.val).toFixed(2).replace('.00','')} ${s.unit}`;
        const parseDate = (d) => {
            if(!d) return new Date();
            const p = d.split('-'); // input date uses YYYY-MM-DD
            if(p.length === 3) return new Date(p[0], p[1]-1, p[2]);
            const p2 = d.split('/'); // display uses DD/MM/YYYY
            if(p2.length === 3) return new Date(p2[2], p2[1]-1, p2[0]);
            return new Date();
        }
        const getDaysLeft = (validityStr) => {
            if (!validityStr) return 999;
            const today = new Date(); 
            today.setHours(0,0,0,0);
            const valDate = parseDate(validityStr);
            const diff = valDate - today;
            return Math.ceil(diff / (1000 * 60 * 60 * 24));
        }
        
        // STORAGE
        const save = () => localStorage.setItem('almox_data_v2', JSON.stringify(state));
        const load = () => {
            const data = localStorage.getItem('almox_data_v2');
            if(data) {
                const p = JSON.parse(data);
                state.warehouses = p.warehouses || state.warehouses;
                state.historyWithdraw = p.historyWithdraw || [];
                state.historyDiscard = p.historyDiscard || [];
            }
        };

        // CORE FUNCTIONS
        
        // Render List
        function renderList() {
            els.list.innerHTML = '';
            const items = state.warehouses[state.currentWarehouse] || [];
            
            const filtered = items.filter(i => {
                // Search term filter
                const term = state.searchTerm.toLowerCase();
                const matchesSearch = i.desc.toLowerCase().includes(term) || 
                       i.code.toLowerCase().includes(term) || 
                       i.lotes.some(l => l.id.toLowerCase().includes(term));

                // Date status filter
                let matchesFilter = true;
                if (state.filterStatus === 'expired') {
                    matchesFilter = i.lotes.some(l => getDaysLeft(l.validity) < 0);
                } else if (state.filterStatus === 'warning') {
                    matchesFilter = i.lotes.some(l => {
                        const d = getDaysLeft(l.validity);
                        return d >= 0 && d <= 30;
                    });
                }

                return matchesSearch && matchesFilter;
            });

            // Update filter counts buttons text
            const countExpired = items.filter(i => i.lotes.some(l => getDaysLeft(l.validity) < 0)).length;
            const countWarning = items.filter(i => i.lotes.some(l => { const d = getDaysLeft(l.validity); return d >= 0 && d <= 30; })).length;
            
            // Update button texts safely
            const btnExpired = document.querySelector('button[data-filter="expired"]');
            if(btnExpired) btnExpired.innerHTML = `<span class="w-2 h-2 rounded-full bg-red-500 inline-block mr-1"></span> Vencidos (${countExpired})`;
            
            const btnWarning = document.querySelector('button[data-filter="warning"]');
            if(btnWarning) btnWarning.innerHTML = `<span class="w-2 h-2 rounded-full bg-amber-500 inline-block mr-1"></span> A Vencer (${countWarning})`;


            if(filtered.length === 0) {
                els.list.innerHTML = `<div class="p-8 text-center text-slate-400 text-sm">Nenhum item encontrado.</div>`;
                return;
            }

            filtered.forEach(item => {
                const total = item.lotes.reduce((acc, l) => acc + l.stock.val, 0);
                const unit = item.lotes[0]?.stock.unit || (item.format === 'Unidade' ? 'un' : item.format.toLowerCase());
                const isSelected = item.code === state.selectedCode;
                
                // Status Logic
                let statusColor = 'bg-slate-100 text-slate-500';
                if(item.lotes.some(l => l.status === 'Crítico')) statusColor = 'bg-red-50 text-red-600 border-red-100';
                else if(item.lotes.some(l => l.status === 'Baixo')) statusColor = 'bg-amber-50 text-amber-600 border-amber-100';
                else if(total > 0) statusColor = 'bg-emerald-50 text-emerald-600 border-emerald-100';

                // New Logic for Expiration Warning in List
                let expBadge = '';
                if (item.lotes.length > 0) {
                    // Find the most critical expiration date
                    const daysList = item.lotes.map(l => getDaysLeft(l.validity));
                    const minDays = Math.min(...daysList);

                    if (minDays < 0) {
                        expBadge = `<span class="ml-2 inline-flex items-center px-1.5 py-0.5 rounded text-[9px] font-bold bg-red-100 text-red-600 border border-red-200" title="Item vencido"><ion-icon name="alert-circle" class="mr-1"></ion-icon> Vencido</span>`;
                    } else if (minDays === 0) {
                        expBadge = `<span class="ml-2 inline-flex items-center px-1.5 py-0.5 rounded text-[9px] font-bold bg-red-50 text-red-500 border border-red-100" title="Vence hoje"><ion-icon name="warning" class="mr-1"></ion-icon> Hoje</span>`;
                    } else if (minDays <= 30) {
                        expBadge = `<span class="ml-2 inline-flex items-center px-1.5 py-0.5 rounded text-[9px] font-bold bg-amber-50 text-amber-600 border border-amber-100" title="Vence em ${minDays} dias"><ion-icon name="time" class="mr-1"></ion-icon> ${minDays}d</span>`;
                    }
                }

                const div = document.createElement('div');
                div.className = `p-4 border-b border-slate-50 hover:bg-slate-50 cursor-pointer transition-all flex justify-between items-center group ${isSelected ? 'selected' : ''}`;
                div.onclick = () => { state.selectedCode = item.code; render(); };
                div.innerHTML = `
                    <div class="flex-grow min-w-0 pr-2">
                        <div class="flex items-center">
                            <h3 class="font-bold text-slate-700 text-sm group-hover:text-blue-600 transition-colors truncate">${item.desc}</h3>
                            ${expBadge}
                        </div>
                        <p class="text-xs text-slate-400 mt-1 truncate">Ref: ${item.code} • ${item.loc}</p>
                    </div>
                    <div class="text-right shrink-0">
                        <span class="block font-bold text-slate-800">${parseFloat(total.toFixed(2))} <span class="text-xs font-normal text-slate-500">${unit}</span></span>
                        <span class="inline-block mt-1 px-2 py-0.5 rounded-full border text-[10px] font-bold uppercase tracking-wide ${statusColor}">${total > 0 ? 'Disponível' : 'Esgotado'}</span>
                    </div>
                `;
                els.list.appendChild(div);
            });
        }

        // Render Details
        function renderDetails() {
            // Limpa apenas o conteúdo interno que é dinâmico
            const existingContent = els.details.querySelector('.details-content');
            if(existingContent) existingContent.remove();
            
            if(!state.selectedCode) {
                els.placeholder.style.display = 'flex';
                return;
            }
            els.placeholder.style.display = 'none';

            const item = state.warehouses[state.currentWarehouse].find(i => i.code === state.selectedCode);
            if(!item) return;

            const content = document.createElement('div');
            content.className = 'details-content flex flex-col h-full animate-fade-in bg-slate-50/50';
            
            // Header Detalhes
            content.innerHTML = `
                <div class="p-6 border-b border-slate-200 bg-white sticky top-0 z-10 flex justify-between items-start shadow-sm">
                    <div>
                        <div class="flex items-center space-x-2 mb-2">
                            <span class="px-2.5 py-0.5 bg-blue-50 text-blue-700 rounded-full text-[10px] font-bold uppercase border border-blue-100 tracking-wide">${item.format}</span>
                            <span class="text-xs text-slate-400 font-medium bg-slate-50 px-2 py-0.5 rounded-full border border-slate-100">Bloco ${item.block}</span>
                        </div>
                        <h2 class="text-2xl font-bold text-slate-800 leading-tight">${item.desc}</h2>
                        <div class="flex items-center gap-3 mt-2 text-sm text-slate-500">
                            <span>Ref: <span class="font-mono text-slate-700 font-semibold">${item.code}</span></span>
                            <span class="text-slate-300">•</span>
                            <span>Local: <span class="text-slate-700 font-medium">${item.loc}</span></span>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                         <button onclick="openProductModal(true)" class="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Editar Produto">
                            <ion-icon name="create-outline" class="text-xl"></ion-icon>
                        </button>
                        <button onclick="deleteProduct()" class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Excluir Produto">
                            <ion-icon name="trash-outline" class="text-xl"></ion-icon>
                        </button>
                    </div>
                </div>

                <div class="flex-grow overflow-y-auto p-6">
                    <div class="flex justify-between items-center mb-5">
                        <h3 class="text-sm font-bold text-slate-800 uppercase tracking-wide flex items-center">
                            <ion-icon name="layers-outline" class="mr-2 text-lg text-slate-400"></ion-icon>
                            Lotes em Estoque
                        </h3>
                        <button onclick="openLotModal()" class="text-white bg-blue-600 hover:bg-blue-700 text-sm font-bold px-4 py-2 rounded-lg shadow-lg shadow-blue-600/20 transition-all flex items-center">
                            <ion-icon name="add-circle" class="mr-1.5 text-lg"></ion-icon> Adicionar Lote
                        </button>
                    </div>

                    <div class="grid grid-cols-1 gap-4">
                        ${item.lotes.length === 0 ? '<div class="p-8 text-center bg-white rounded-xl border border-dashed border-slate-300"><p class="text-slate-400">Nenhum lote cadastrado.</p></div>' : ''}
                        ${item.lotes.map(lot => {
                            const daysLeft = getDaysLeft(lot.validity);
                            
                            // Visual Logic for Expiration
                            let dateBgClass, dateTextClass, dateBorderClass, dateIcon, dateLabel, dateDisplay, statusColorClass, indicatorColor;

                            if (daysLeft < 0) {
                                // Vencido
                                indicatorColor = 'bg-red-500';
                                dateBgClass = 'bg-red-50';
                                dateBorderClass = 'border-red-100';
                                dateTextClass = 'text-red-600';
                                dateIcon = 'alert-circle';
                                dateLabel = 'Vencido há';
                                dateDisplay = `${Math.abs(daysLeft)} dias`;
                                statusColorClass = 'bg-red-100 text-red-700';
                            } else if (daysLeft === 0) {
                                // Vence Hoje
                                indicatorColor = 'bg-red-500';
                                dateBgClass = 'bg-red-50';
                                dateBorderClass = 'border-red-200';
                                dateTextClass = 'text-red-700';
                                dateIcon = 'warning';
                                dateLabel = 'Atenção';
                                dateDisplay = 'Vence Hoje';
                                statusColorClass = 'bg-red-100 text-red-700';
                            } else if (daysLeft <= 30) {
                                // Alerta
                                indicatorColor = 'bg-amber-500';
                                dateBgClass = 'bg-amber-50';
                                dateBorderClass = 'border-amber-100';
                                dateTextClass = 'text-amber-700';
                                dateIcon = 'time';
                                dateLabel = 'Vence em';
                                dateDisplay = `${daysLeft} dias`;
                                statusColorClass = 'bg-amber-100 text-amber-700';
                            } else {
                                // OK
                                indicatorColor = 'bg-emerald-500';
                                dateBgClass = 'bg-emerald-50';
                                dateBorderClass = 'border-emerald-100';
                                dateTextClass = 'text-emerald-700';
                                dateIcon = 'checkmark-circle';
                                dateLabel = 'Vence em';
                                dateDisplay = `${daysLeft} dias`;
                                statusColorClass = 'bg-emerald-100 text-emerald-700';
                            }

                            return `
                            <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all duration-300 relative group overflow-hidden">
                                <!-- Visual Indicator Bar on Left -->
                                <div class="absolute left-0 top-0 bottom-0 w-1 ${indicatorColor}"></div>
                                
                                <div class="pl-3 flex justify-between items-start mb-4">
                                    <div>
                                        <div class="flex items-center gap-2">
                                            <span class="font-mono text-lg font-bold text-slate-700 tracking-tight">${lot.id}</span>
                                            ${lot.retained ? '<span class="px-2 py-0.5 bg-slate-100 text-slate-600 text-[10px] font-bold uppercase rounded-full border border-slate-200">Retido</span>' : ''}
                                        </div>
                                        <div class="mt-1 flex items-center text-sm text-slate-500">
                                            <ion-icon name="calendar-outline" class="mr-1.5"></ion-icon>
                                            Validade: ${lot.validity}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span class="block text-2xl font-bold text-slate-800 tracking-tight">${formatStock(lot.stock)}</span>
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide ${statusColorClass}">
                                            ${lot.status}
                                        </span>
                                    </div>
                                </div>

                                <!-- Countdown Section -->
                                <div class="pl-3 mb-4">
                                    <div class="flex items-center p-3 rounded-xl ${dateBgClass} border ${dateBorderClass}">
                                        <div class="p-2 rounded-full bg-white/50 mr-3">
                                            <ion-icon name="${dateIcon}" class="text-xl ${dateTextClass}"></ion-icon>
                                        </div>
                                        <div>
                                            <p class="text-xs font-semibold uppercase opacity-70 ${dateTextClass}">${dateLabel}</p>
                                            <p class="text-sm font-bold ${dateTextClass}">${dateDisplay}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Actions -->
                                <div class="pl-3 flex justify-end gap-2 pt-2 border-t border-slate-50 opacity-100 sm:opacity-60 group-hover:opacity-100 transition-opacity">
                                     <button onclick="openLotModal('${lot.id}')" class="text-slate-500 hover:text-blue-600 text-xs font-semibold px-3 py-2 rounded-lg hover:bg-slate-50 flex items-center transition-colors">
                                        <ion-icon name="create-outline" class="mr-1.5 text-base"></ion-icon> Editar
                                    </button>
                                    <button onclick="toggleRetain('${lot.id}')" class="text-slate-500 hover:text-amber-600 text-xs font-semibold px-3 py-2 rounded-lg hover:bg-slate-50 flex items-center transition-colors">
                                        <ion-icon name="${lot.retained ? 'lock-open' : 'lock-closed'}-outline" class="mr-1.5 text-base"></ion-icon> ${lot.retained ? 'Liberar' : 'Reter'}
                                    </button>
                                    <button onclick="openDiscard('${lot.id}')" class="text-slate-500 hover:text-red-600 text-xs font-semibold px-3 py-2 rounded-lg hover:bg-slate-50 flex items-center transition-colors" ${lot.retained ? 'disabled' : ''}>
                                        <ion-icon name="trash-outline" class="mr-1.5 text-base"></ion-icon> Descarte
                                    </button>
                                    <button onclick="openWithdraw('${lot.id}')" class="bg-slate-800 hover:bg-slate-900 text-white text-xs font-bold px-4 py-2 rounded-lg shadow-md transition-colors flex items-center ml-2" ${lot.retained ? 'disabled' : ''}>
                                        Saída <ion-icon name="arrow-forward-outline" class="ml-1.5"></ion-icon>
                                    </button>
                                </div>
                            </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            els.details.prepend(content); 
        }

        // Render Reports
        function renderReports() {
            // Withdraw
            els.reportBody.innerHTML = state.historyWithdraw.slice().reverse().map(h => `
                <tr class="hover:bg-slate-50">
                    <td class="px-6 py-4 text-sm text-slate-600 whitespace-nowrap">${h.date}</td>
                    <td class="px-6 py-4 text-sm font-medium text-slate-800">${h.req}</td>
                    <td class="px-6 py-4 text-sm text-slate-500">${h.sector || '-'}</td>
                    <td class="px-6 py-4 text-sm text-slate-600">${h.item}</td>
                    <td class="px-6 py-4 text-sm font-mono text-slate-500">${h.lot}</td>
                    <td class="px-6 py-4 text-sm font-bold text-slate-800">${h.qty}</td>
                </tr>
            `).join('') || '<tr><td colspan="6" class="p-4 text-center text-slate-400">Sem registros.</td></tr>';

            // Discard
            els.discardBody.innerHTML = state.historyDiscard.slice().reverse().map(h => `
                <tr class="hover:bg-slate-50">
                    <td class="px-6 py-4 text-sm text-slate-600 whitespace-nowrap">${h.date}</td>
                    <td class="px-6 py-4 text-sm font-medium text-slate-800">${h.item}</td>
                    <td class="px-6 py-4 text-sm font-mono text-slate-500">${h.lot}</td>
                    <td class="px-6 py-4 text-sm font-bold text-red-600">${h.qty}</td>
                    <td class="px-6 py-4 text-sm text-slate-500 italic">${h.reason}</td>
                </tr>
            `).join('') || '<tr><td colspan="5" class="p-4 text-center text-slate-400">Sem registros.</td></tr>';
        }

        function render() {
            renderList();
            renderDetails();
        }

        // Filter Logic (Event Listeners)
        els.filterBtns.forEach(btn => {
            btn.onclick = () => {
                // Update active state class
                els.filterBtns.forEach(b => {
                    b.classList.remove('active-all', 'active-expired', 'active-warning', 'bg-slate-800', 'text-white');
                    // Reset standard styles
                    b.className = b.className.replace('active', '').trim();
                    b.classList.add('bg-white', 'text-slate-500'); 
                });

                // Set new active
                const filter = btn.dataset.filter;
                state.filterStatus = filter;
                
                // Add specific active class based on filter type
                btn.classList.remove('bg-white', 'text-slate-500');
                if(filter === 'all') btn.classList.add('active', 'active-all');
                else if(filter === 'expired') btn.classList.add('active', 'active-expired');
                else if(filter === 'warning') btn.classList.add('active', 'active-warning');

                renderList();
            };
        });

        // ACTIONS LOGIC
        
        // Modal Logic (SAFEGUARDED)
        function showModal(id) {
            const modal = document.getElementById(id);
            if (!modal) return; // Segurança contra null

            const content = modal.querySelector('div[id$="-content"]');
            const bg = modal.querySelector('div[id$="-bg"]');
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                if(bg) bg.classList.remove('opacity-0');
                if(content) {
                    content.classList.remove('scale-95', 'opacity-0');
                    content.classList.add('scale-100', 'opacity-100');
                }
            }, 10);
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            if (!modal) return; // Segurança contra null

            const content = modal.querySelector('div[id$="-content"]');
            const bg = modal.querySelector('div[id$="-bg"]');

            if(content) {
                content.classList.remove('scale-100', 'opacity-100');
                content.classList.add('scale-95', 'opacity-0');
            }
            if(bg) bg.classList.add('opacity-0');
            
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        document.querySelectorAll('.close-modal-btn').forEach(b => b.onclick = (e) => {
            const modal = e.target.closest('.fixed');
            if(modal) closeModal(modal.id);
        });

        // Product Actions
        window.openProductModal = (isEdit = false) => {
            els.prodForm.reset();
            document.getElementById('edit-original-code').value = '';
            document.getElementById('product-modal-title').innerText = isEdit ? 'Editar Produto' : 'Cadastrar Produto';
            
            if(isEdit) {
                const item = state.warehouses[state.currentWarehouse].find(i => i.code === state.selectedCode);
                if(item) {
                    document.getElementById('product-warehouse').value = state.currentWarehouse;
                    document.getElementById('product-desc').value = item.desc;
                    document.getElementById('product-code').value = item.code;
                    document.getElementById('product-loc').value = item.loc;
                    document.getElementById('product-block').value = item.block;
                    document.getElementById('product-format').value = item.format;
                    document.getElementById('edit-original-code').value = item.code;
                }
            } else {
                document.getElementById('product-warehouse').value = state.currentWarehouse;
            }
            showModal('product-modal');
        };

        els.prodForm.onsubmit = (e) => {
            e.preventDefault();
            const wh = document.getElementById('product-warehouse').value;
            const code = document.getElementById('product-code').value.trim();
            const originalCode = document.getElementById('edit-original-code').value;
            
            // Check Duplicate (if new or code changed)
            if((!originalCode || code !== originalCode) && state.warehouses[wh].some(i => i.code === code)) {
                toast('Código já existe!', 'error'); return;
            }

            const newItem = {
                code,
                desc: document.getElementById('product-desc').value.trim(),
                loc: document.getElementById('product-loc').value.trim(),
                block: document.getElementById('product-block').value.trim(),
                format: document.getElementById('product-format').value,
                lotes: []
            };

            if(originalCode) {
                // Edit Mode: Keep lots, remove old item, add new updated item
                const oldItemIdx = state.warehouses[state.currentWarehouse].findIndex(i => i.code === originalCode);
                if(oldItemIdx > -1) {
                    newItem.lotes = state.warehouses[state.currentWarehouse][oldItemIdx].lotes;
                    // Remove old
                    state.warehouses[state.currentWarehouse].splice(oldItemIdx, 1);
                    // If warehouse changed, move lots there. If not, stays same.
                    state.warehouses[wh].push(newItem);
                    state.selectedCode = code; // Update selection
                    state.currentWarehouse = wh; // Switch tab if moved
                }
            } else {
                // New Mode
                state.warehouses[wh].push(newItem);
                state.currentWarehouse = wh;
            }
            
            // Sort
            state.warehouses[wh].sort((a,b) => a.desc.localeCompare(b.desc));
            
            save();
            render();
            closeModal('product-modal');
            toast('Produto salvo com sucesso!', 'success');
            
            // Update UI tabs
            document.querySelectorAll('.warehouse-tab').forEach(t => {
                if(t.dataset.warehouse === state.currentWarehouse) t.click();
            });
        };

        window.deleteProduct = () => {
            if(!confirm('Tem certeza? Isso apagará o produto e todos os lotes.')) return;
            const idx = state.warehouses[state.currentWarehouse].findIndex(i => i.code === state.selectedCode);
            if(idx > -1) {
                state.warehouses[state.currentWarehouse].splice(idx, 1);
                state.selectedCode = null;
                save();
                render();
                toast('Produto excluído.', 'success');
            }
        };

        // Lot Actions
        window.openLotModal = (lotId = null) => {
            els.lotForm.reset();
            document.getElementById('edit-original-lot-id').value = '';
            document.getElementById('lot-modal-title').innerText = lotId ? 'Editar Lote' : 'Adicionar Lote';

            if(lotId) {
                const item = state.warehouses[state.currentWarehouse].find(i => i.code === state.selectedCode);
                const lot = item.lotes.find(l => l.id === lotId);
                if(lot) {
                    document.getElementById('lot-code').value = lot.id;
                    document.getElementById('edit-original-lot-id').value = lot.id;
                    // Convert display date DD/MM/YYYY to input YYYY-MM-DD
                    const [d,m,y] = lot.validity.split('/');
                    document.getElementById('lot-validity').value = `${y}-${m}-${d}`;
                    document.getElementById('lot-stock').value = formatStock(lot.stock).replace(/ [a-zA-Z]+$/,''); // Just num
                    document.getElementById('lot-status').value = lot.status;
                }
            }
            showModal('lot-modal');
        };

        els.lotForm.onsubmit = (e) => {
            e.preventDefault();
            const item = state.warehouses[state.currentWarehouse].find(i => i.code === state.selectedCode);
            const id = document.getElementById('lot-code').value.trim();
            const originalId = document.getElementById('edit-original-lot-id').value;

            // Duplicate Check
            if((!originalId || id !== originalId) && item.lotes.some(l => l.id === id)) {
                toast('Lote já existe neste produto!', 'error'); return;
            }

            const dateVal = document.getElementById('lot-validity').value;
            const [y,m,d] = dateVal.split('-');

            const newLot = {
                id,
                validity: `${d}/${m}/${y}`,
                stock: { val: parseFloat(document.getElementById('lot-stock').value), unit: item.format === 'Unidade' ? 'un' : item.format.toLowerCase() },
                status: document.getElementById('lot-status').value,
                retained: false
            };

            if(originalId) {
                const idx = item.lotes.findIndex(l => l.id === originalId);
                newLot.retained = item.lotes[idx].retained; // Keep state
                item.lotes[idx] = newLot;
            } else {
                item.lotes.push(newLot);
            }
            
            // Sort by validity
            item.lotes.sort((a,b) => parseDate(a.validity) - parseDate(b.validity));

            save();
            renderDetails(); // Only details needed
            closeModal('lot-modal');
            toast('Lote salvo.', 'success');
        };

        window.toggleRetain = (lid) => {
            const item = state.warehouses[state.currentWarehouse].find(i => i.code === state.selectedCode);
            const l = item.lotes.find(lot => lot.id === lid);
            l.retained = !l.retained;
            save(); renderDetails();
        };

        // Withdraw / Discard
        window.openWithdraw = (lid) => {
            const item = state.warehouses[state.currentWarehouse].find(i => i.code === state.selectedCode);
            const l = item.lotes.find(lot => lot.id === lid);
            
            document.getElementById('withdraw-item-code').value = item.code;
            document.getElementById('withdraw-lot-id').value = lid;
            document.getElementById('withdraw-item-display').innerText = item.desc;
            document.getElementById('withdraw-lot-display').innerText = lid;
            document.getElementById('withdraw-stock-display').innerText = formatStock(l.stock);
            document.getElementById('withdraw-unit-display').innerText = l.stock.unit;
            document.getElementById('withdraw-qty').value = '';
            
            // Default internal
            document.getElementById('btn-type-internal').click();
            showModal('withdraw-modal');
        };

        // Toggle Withdraw Type
        document.getElementById('btn-type-internal').onclick = function() {
            this.classList.add('active'); document.getElementById('btn-type-external').classList.remove('active');
            document.getElementById('external-fields').classList.add('hidden');
            els.withdrawForm.dataset.type = 'internal';
        };
        document.getElementById('btn-type-external').onclick = function() {
            this.classList.add('active'); document.getElementById('btn-type-internal').classList.remove('active');
            document.getElementById('external-fields').classList.remove('hidden');
            els.withdrawForm.dataset.type = 'external';
        };

        els.withdrawForm.onsubmit = (e) => {
            e.preventDefault();
            const qty = parseFloat(document.getElementById('withdraw-qty').value);
            const code = document.getElementById('withdraw-item-code').value;
            const lid = document.getElementById('withdraw-lot-id').value;
            const type = els.withdrawForm.dataset.type;

            const item = state.warehouses[state.currentWarehouse].find(i => i.code === code);
            const lot = item.lotes.find(l => l.id === lid);

            if(qty > lot.stock.val) { toast('Estoque insuficiente!', 'error'); return; }

            lot.stock.val -= qty;
            
            const rec = {
                date: new Date().toLocaleDateString('pt-BR') + ' ' + new Date().toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'}),
                req: type === 'internal' ? 'Interno' : document.getElementById('withdraw-requester').value,
                sector: type === 'internal' ? 'Almoxarifado' : document.getElementById('withdraw-sector').value,
                cc: type === 'internal' ? '-' : document.getElementById('withdraw-cost-center').value,
                item: item.desc,
                itemCode: item.code,
                lot: lot.id,
                qty: `${qty} ${lot.stock.unit}`
            };
            state.historyWithdraw.push(rec);
            save();
            render();
            closeModal('withdraw-modal');
            toast('Saída registrada.', 'success');

            if(type === 'external') showReceipt(rec);
        };

        function showReceipt(data) {
            document.getElementById('receipt-date').innerText = data.date;
            document.getElementById('receipt-requester').innerText = data.req;
            document.getElementById('receipt-sector').innerText = data.sector;
            document.getElementById('receipt-cost-center').innerText = data.cc === '-' ? '' : `CC: ${data.cc}`;
            document.getElementById('receipt-product').innerText = data.item;
            document.getElementById('receipt-lot').innerText = data.lot;
            document.getElementById('receipt-qty').innerText = data.qty;
            showModal('receipt-modal');
        }

        window.openDiscard = (lid) => {
            const item = state.warehouses[state.currentWarehouse].find(i => i.code === state.selectedCode);
            const l = item.lotes.find(lot => lot.id === lid);

            document.getElementById('discard-item-code').value = item.code;
            document.getElementById('discard-lot-id').value = lid;
            document.getElementById('discard-item-display').innerText = `${item.desc} (Lote ${lid})`;
            showModal('discard-modal');
        };

        els.discardForm.onsubmit = (e) => {
            e.preventDefault();
            const qty = parseFloat(document.getElementById('discard-qty').value);
            const lid = document.getElementById('discard-lot-id').value;
            const item = state.warehouses[state.currentWarehouse].find(i => i.code === state.selectedCode);
            const lot = item.lotes.find(l => l.id === lid);

            if(qty > lot.stock.val) { toast('Erro: Qtd maior que estoque.', 'error'); return; }

            lot.stock.val -= qty;
            state.historyDiscard.push({
                date: new Date().toLocaleDateString('pt-BR'),
                item: item.desc,
                lot: lid,
                qty: `${qty} ${lot.stock.unit}`,
                reason: document.getElementById('discard-reason').value
            });
            save(); render(); closeModal('discard-modal'); toast('Descarte registrado.', 'warning');
        };


        // TABS
        els.tabs.forEach(t => t.onclick = () => {
            els.tabs.forEach(x => x.classList.remove('active'));
            t.classList.add('active');
            state.currentWarehouse = t.dataset.warehouse;
            state.selectedCode = null;
            
            if(state.currentWarehouse.includes('relatorio')) {
                document.getElementById('main-view-container').classList.add('hidden');
                document.getElementById('report-view-container').classList.toggle('hidden', state.currentWarehouse !== 'relatorio');
                document.getElementById('discard-report-view-container').classList.toggle('hidden', state.currentWarehouse !== 'relatorioDescarte');
                renderReports();
            } else {
                document.getElementById('main-view-container').classList.remove('hidden');
                document.getElementById('report-view-container').classList.add('hidden');
                document.getElementById('discard-report-view-container').classList.add('hidden');
                renderList();
                renderDetails();
            }
        });

        // TOAST
        function toast(msg, type='info') {
            const t = document.createElement('div');
            const colors = type === 'error' ? 'bg-red-500' : (type === 'success' ? 'bg-green-500' : (type === 'warning' ? 'bg-amber-500' : 'bg-slate-800'));
            t.className = `${colors} text-white px-6 py-3 rounded-xl shadow-lg transform transition-all duration-300 translate-x-10 opacity-0 flex items-center text-sm font-medium`;
            t.innerHTML = `<ion-icon name="${type === 'success' ? 'checkmark' : 'alert'}-circle-outline" class="mr-2 text-xl"></ion-icon> ${msg}`;
            els.toastContainer.appendChild(t);
            setTimeout(() => t.classList.remove('translate-x-10', 'opacity-0'), 100);
            setTimeout(() => {
                t.classList.add('translate-x-10', 'opacity-0');
                setTimeout(() => t.remove(), 300);
            }, 4000);
        }

        // INIT & IMPORT
        document.getElementById('show-add-product-modal-btn').onclick = () => window.openProductModal();
        
        // NOVO: Ao abrir modal de importação, pré-seleciona a aba atual
        document.getElementById('show-import-modal-btn').onclick = () => {
            const current = state.currentWarehouse;
            // Se a aba atual for um dos segmentos válidos, seleciona ele
            if(['doces', 'salgados', 'materiaPrima'].includes(current)) {
                document.getElementById('import-segment').value = current;
            }
            // Limpa o textarea
            document.getElementById('csv-input').value = '';
            showModal('import-modal');
        };

        if (els.showHelpBtn) {
            els.showHelpBtn.onclick = () => showModal('help-modal');
        }

        document.getElementById('search-bar').oninput = (e) => { state.searchTerm = e.target.value; renderList(); };
        document.getElementById('export-data-btn').onclick = () => {
             const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
             const downloadAnchorNode = document.createElement('a');
             downloadAnchorNode.setAttribute("href",     dataStr);
             downloadAnchorNode.setAttribute("download", "backup_almoxarifado.json");
             document.body.appendChild(downloadAnchorNode);
             downloadAnchorNode.click();
             downloadAnchorNode.remove();
        };

        // CSV Import Logic (Robust & Segment Aware)
        document.getElementById('confirm-import-btn').onclick = () => {
            const csv = document.getElementById('csv-input').value;
            const targetSegment = document.getElementById('import-segment').value; // Pega o segmento escolhido
            const clearMode = document.getElementById('import-clear-mode').checked; // Verifica se deve limpar

            if(!csv) {
                toast('Por favor, cole os dados para importar.', 'error');
                return;
            }

            const lines = csv.split('\n');
            let count = 0;
            
            // Detecta separador (Tab, Ponto e Vírgula ou Vírgula)
            const firstLine = lines[0] || '';
            const sep = firstLine.includes('\t') ? '\t' : (firstLine.includes(';') ? ';' : ',');

            // Define o armazém de destino com base na escolha do usuário
            const warehouse = state.warehouses[targetSegment];

            // SE O MODO SUBSTITUIR ESTIVER ATIVO, LIMPA O ARMAZÉM ANTES
            if(clearMode) {
                warehouse.length = 0; // Esvazia o array mantendo a referência
            }

            lines.forEach(l => {
                if(!l.trim()) return; // Pula linhas vazias
                const c = l.split(sep).map(s => s.trim());
                
                // Espera estrutura: 
                // 0: CÓDIGO, 1: DESCRIÇÃO, 2: LOTE, 3: QUANTIDADE, 4: FABRICAÇÃO, 5: VALIDADE, 6: DIAS, 7: STATUS
                
                if(c.length < 2) return; // Linha inválida se não tiver nem código nem descrição

                const code = c[0];
                // Pula cabeçalho
                if(code.toUpperCase().includes('CÓDIGO') || code.toUpperCase() === 'CODIGO') return;

                const desc = c[1];
                const lotId = c[2];
                const qtyStr = c[3];
                // c[4] (Fabricação) ignorado pois sistema foca na validade
                const validityRaw = c[5]; 
                // c[6] (Dias a vencer) ignorado pois é calculado dinamicamente
                const status = c[7] || 'OK';

                // Procura se o produto já existe pelo CÓDIGO
                let item = warehouse.find(i => i.code === code);
                
                // Se não existe, cria novo produto
                if(!item) {
                    // Tenta adivinhar formato pela unidade da quantidade (ex: ml -> Líquido)
                    let format = 'Unidade';
                    if (qtyStr) {
                        const lowerQty = qtyStr.toLowerCase();
                        if (lowerQty.includes('ml') || lowerQty.includes('l') || lowerQty.includes('litro')) format = 'Líquido';
                        else if (lowerQty.includes('kg') || lowerQty.includes('g')) format = 'Kg'; // ou Pó/Pasta
                    }

                    item = {
                        code, 
                        desc, 
                        loc: '-', // Valor padrão
                        block: '-', // Valor padrão
                        format: format,
                        lotes: []
                    };
                    warehouse.push(item);
                }

                // Se houver informação de LOTE, adiciona/atualiza
                if(lotId) {
                    // Tratamento de Data (Aceita DD/MM/AAAA)
                    // O sistema espera DD/MM/AAAA para exibição
                    let finalValidity = validityRaw;
                    
                    // Tratamento de Estoque
                    const stock = parseStock(qtyStr);

                    // Procura lote existente. 
                    // Se clearMode=true, existingLotIdx será -1 (a menos que o CSV tenha duplicatas do mesmo lote)
                    const existingLotIdx = item.lotes.findIndex(lt => lt.id === lotId);
                    
                    const newLot = {
                        id: lotId,
                        validity: finalValidity || new Date().toLocaleDateString('pt-BR'), // Fallback para hoje se vazio
                        stock: stock,
                        status: status,
                        retained: false
                    };

                    if(existingLotIdx > -1) {
                        // Atualiza lote existente (preserva se estava retido)
                        newLot.retained = item.lotes[existingLotIdx].retained;
                        item.lotes[existingLotIdx] = newLot; 
                    } else {
                        item.lotes.push(newLot);
                    }
                    
                    // Ordena lotes por validade
                    item.lotes.sort((a,b) => parseDate(a.validity) - parseDate(b.validity));
                }
                
                count++;
            });
            
            // Ordena produtos por descrição
            warehouse.sort((a,b) => a.desc.localeCompare(b.desc));

            save();
            
            // Muda para a aba onde os dados foram importados para o usuário ver
            state.currentWarehouse = targetSegment;
            state.selectedCode = null; // Reseta seleção para evitar erros
            
            // Atualiza visual das abas
            document.querySelectorAll('.warehouse-tab').forEach(t => {
                if(t.dataset.warehouse === targetSegment) {
                    t.classList.add('active');
                } else {
                    t.classList.remove('active');
                }
            });
            
            // Se estava em relatório, volta para a visualização principal
            document.getElementById('main-view-container').classList.remove('hidden');
            document.getElementById('report-view-container').classList.add('hidden');
            document.getElementById('discard-report-view-container').classList.add('hidden');

            render();
            closeModal('import-modal');
            
            const whLabel = targetSegment === 'doces' ? 'Aromas Doces' : (targetSegment === 'salgados' ? 'Aromas Salgados' : 'Matéria Prima');
            if (count > 0) {
                toast(`${count} registros importados em ${whLabel}.`, 'success');
            } else {
                toast('Nenhum dado válido encontrado. Verifique o formato.', 'warning');
            }
        };

        // NEW: Clear All Logic
        document.getElementById('clear-all-btn').onclick = () => {
            // Check if we are in a warehouse tab
            if(['doces', 'salgados', 'materiaPrima'].includes(state.currentWarehouse)) {
                const names = { doces: 'Aromas Doces', salgados: 'Aromas Salgados', materiaPrima: 'Matéria Prima' };
                document.getElementById('clear-target-name').innerText = names[state.currentWarehouse];
                showModal('clear-all-modal');
            } else {
                toast('Selecione uma aba de estoque para limpar.', 'warning');
            }
        };

        // Confirm Clear All
        document.getElementById('confirm-clear-all-btn').onclick = () => {
            if(['doces', 'salgados', 'materiaPrima'].includes(state.currentWarehouse)) {
                state.warehouses[state.currentWarehouse] = [];
                state.selectedCode = null; // Reset selection
                save();
                render();
                closeModal('clear-all-modal');
                toast('Setor limpo com sucesso.', 'success');
            }
        };

        // Clear Report History
        document.getElementById('clear-report-btn').onclick = () => {
            if(confirm('Deseja apagar todo o histórico de retiradas?')) {
                state.historyWithdraw = [];
                save();
                renderReports();
                toast('Histórico apagado.', 'success');
            }
        };
        
        // Load & Start
        load();
        
        // NOVO: Verifica se o botão de ajuda deve pulsar e adiciona listeners com segurança
        if (els.showHelpBtn) {
            try {
                if (localStorage.getItem('helpViewed') !== 'true') {
                     els.showHelpBtn.classList.add('pulse-anim');
                }
            } catch (e) {
                console.warn("Não foi possível ler 'helpViewed' do localStorage.", e);
                els.showHelpBtn.classList.add('pulse-anim');
            }
            
            // Remove pulse ao clicar
            els.showHelpBtn.addEventListener('click', () => {
                els.showHelpBtn.classList.remove('pulse-anim');
                localStorage.setItem('helpViewed', 'true');
            });
        }

        render();

    </script>
</body>
</html>




